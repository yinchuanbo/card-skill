
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ºä½•è¯´ AbortController æ˜¯å‰ç«¯ä¸€æŠŠåˆ©å‰‘</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=ZCOOL+QingKe+HuangYou&family=Noto+Serif+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Prism.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
</head>
<body class="card-detail">
    <div class="container">
        <div class="card-content">
            <header>
                <h1>ä¸ºä½•è¯´ AbortController æ˜¯å‰ç«¯ä¸€æŠŠåˆ©å‰‘</h1>
                <div class="meta">
                    <time datetime="Sun Mar 09 2025 02:12:26 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)">2025/3/9</time>
                    <div class="tags">
                        <span class="tag">AbortController</span>
                    </div>
                </div>
            </header>
            <div class="content">
                <h2 id="1-é€šè¿‡-abortcontroller-æå‰ç»ˆæ­¢-fetch">1. é€šè¿‡ AbortController æå‰ç»ˆæ­¢ fetch</h2>
<p>é¦–å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼Œå…¶ä½¿ç”¨ AbortController æ¥å®ç°å¯ä»¥æå‰ä¸­æ­¢çš„ fetchï¼š</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js">fetchButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ·»åŠ å–æ¶ˆæŒ‰é’®</span>
  abortButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/json"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">signal</span><span class="token operator">:</span> controller<span class="token punctuation">.</span>signal <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™é‡Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isUserAbort <span class="token operator">=</span> e<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"AbortError"</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæ˜¯ AbortController å–æ¶ˆçš„åˆ™æ˜¯ AbortErrorï¼ˆä¸€ç§ DOMExceptionï¼‰</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</code></pre>
<p>ä¸Šé¢ç¤ºä¾‹å±•ç¤ºäº†åœ¨ <code>AbortController</code> å‡ºç°ä¹‹å‰ä¸å¯èƒ½å®ç°çš„äº‹æƒ…ï¼Œå³ <code>ä¸»åŠ¨å–æ¶ˆç½‘ç»œè¯·æ±‚</code>ã€‚æµè§ˆå™¨å°†æå‰ç»ˆæ­¢ fetchï¼Œä»è€ŒèŠ‚çœç”¨æˆ·ç½‘ç»œå¸¦å®½ã€‚å½“ç„¶ï¼Œæå‰ç»ˆæ­¢ä¹Ÿä¸å¿…éè¦ç”±ç”¨æˆ·æ‰‹åŠ¨å‘èµ·ã€‚</p>
<p>ä¸Šé¢ç¤ºä¾‹ä¸­ <code>controller.signal</code> è¿”å›çš„æ˜¯ <code>AbortSignal</code>ï¼Œå…¶ä»£è¡¨ä¸€ä¸ªä¿¡å·å¯¹è±¡ï¼Œå…¶å…è®¸å¼€å‘è€…ä¸å¼‚æ­¥æ“ä½œï¼ˆä¾‹å¦‚ fetch è¯·æ±‚ï¼‰è¿›è¡Œé€šä¿¡ï¼Œå¹¶åœ¨éœ€è¦æ—¶é€šè¿‡ AbortController å¯¹è±¡ä¸­æ­¢ã€‚</p>
<p>å¦‚æœå¼€å‘è€…æƒ³ä»å¤šä¸ªä¿¡å·ä¸­ä¸­æ­¢ï¼Œå¯ä»¥ä½¿ç”¨ <code>AbortSignal.any()</code> ç»„åˆæˆå•ä¸ªä¿¡å·ï¼Œæ¯”å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> timeoutSignal <span class="token operator">=</span> AbortSignal<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// This will abort the fetch when either signal is aborted</span>
    <span class="token literal-property property">signal</span><span class="token operator">:</span> AbortSignal<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">[</span>controller<span class="token punctuation">.</span>signal<span class="token punctuation">,</span> timeoutSignal<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"AbortError"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Notify the user of abort.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"TimeoutError"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Notify the user of timeout</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// A network error, or some other problem.</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Message: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
</code></pre>
<p>AbortController å’Œ AbortSignal ä¸¤è€…ç”¨é€”è¿˜æ˜¯æœ‰ä¸€å®šçš„åŒºåˆ«ï¼š</p>
<ul>
<li><code>AbortController</code>ï¼šå…è®¸é€šè¿‡ controller.abort() æ˜¾å¼ä¸­æ­¢å…¶é™„åŠ çš„ä¿¡å·</li>
<li><code>AbortSignal</code> ï¼šä¸èƒ½ç›´æ¥ä¸­æ­¢ï¼Œä½†å¼€å‘è€…å¯ä»¥å°†å…¶ä¼ é€’ç»™ fetch() ä¹‹ç±»çš„è°ƒç”¨æˆ–ç›´æ¥ç›‘å¬å…¶ä¸­æ­¢çŠ¶æ€ã€‚</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨ <code>signal.aborted</code> æ£€æŸ¥å…¶çŠ¶æ€ï¼Œæˆ–ä¸º <code>abort</code> äº‹ä»¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œä¾‹å¦‚ï¼šfetch() åœ¨å†…éƒ¨æ‰§è¡Œæ­¤æ“ä½œ ã€‚</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
signal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</code></pre>
<p>AbortController å–æ¶ˆè¯·æ±‚åæœåŠ¡å™¨å°±ä¸ä¼šç»§ç»­å¤„ç†è¯¥è¯·æ±‚ï¼Œä¹Ÿä¸ä¼šå‘é€å“åº”ï¼Œä»è€Œé¿å…äº†ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“ã€‚åŒæ—¶ï¼Œé’ˆå¯¹å®¢æˆ·ç«¯æ¥è¯´ä¼šå‡å°‘å¹¶å‘çš„è¿æ¥æ•°é‡ï¼Œæé«˜é¡µé¢çš„å“åº”æ€§èƒ½ã€‚</p>
<h2 id="2abortcontroller-çš„å…¸å‹ä½¿ç”¨åœºæ™¯">2.AbortController çš„å…¸å‹ä½¿ç”¨åœºæ™¯</h2>
<h3 id="21-ä¸­æ­¢-websocket-ç­‰ä¼ ç»Ÿå¯¹è±¡">2.1 ä¸­æ­¢ WebSocket ç­‰ä¼ ç»Ÿå¯¹è±¡</h3>
<p>å¾ˆå¤šè€ç‰ˆæœ¬çš„ DOM API å…¶å®å¹¶ä¸æ”¯æŒ AbortSignalï¼Œä¾‹å¦‚ï¼šWebSocketï¼Œå…¶åªæœ‰ä¸€ä¸ª <code>.close()</code> æ–¹æ³•ç”¨äºåœ¨è¯·æ±‚å®Œæˆåå…³é—­è¿æ¥ã€‚æ­¤æ—¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼æ˜¾å¼å–æ¶ˆè¯·æ±‚ï¼š</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">abortableSocket</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>signal<span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    w<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å·²ç»å–æ¶ˆï¼Œç›´æ¥å¤±è´¥</span>
  <span class="token punctuation">}</span>
  signal<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"abort"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> w<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> w<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</code></pre>
<p>è¯·æ³¨æ„ï¼Œå¦‚æœå·²ç»ä¸­æ­¢ï¼ŒAbortSignal ä¸ä¼šè§¦å‘å…¶ â€œabortâ€ï¼Œå› æ­¤å¿…é¡»æ£€æŸ¥æ˜¯å¦å·²ç» abortedï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç«‹å³ .close()ã€‚</p>
<h3 id="22-ç§»é™¤äº‹ä»¶å¤„ç†ç¨‹åº">2.2 ç§»é™¤äº‹ä»¶å¤„ç†ç¨‹åº</h3>
<p>åœ¨é€šè¿‡ removeEventListener ç§»é™¤ DOM äº‹ä»¶å¤„ç†å‡½æ•°æ—¶ï¼Œå¼€å‘è€…å¿…é¡»ä¿è¯ç¬¬äºŒä¸ªäº‹ä»¶å¤„ç†å‡½æ•°æ˜¯åŒä¸€ä¸ªã€‚</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"resize"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// addEventListener å’Œ removeEventListener éåŒä¸€ä¸ªå‡½æ•°</span>
window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"resize"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</code></pre>
<p>æœ‰äº† AbortController åï¼Œè¿™ä¸€åˆ‡å˜å¾—éå¸¸ç®€å•ï¼Œå¼€å‘è€…åªéœ€è¦å°† signal ä¼ é€’ç»™ addEventListener çš„ç¬¬ä¸‰ä¸ªå‚æ•°å³å¯ã€‚</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> signal <span class="token punctuation">}</span> <span class="token operator">=</span> controller<span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"resize"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> signal <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// é€šè¿‡. abort() æ–¹æ³•ç§»é™¤äº‹ä»¶å¤„ç†å‡½æ•°</span>
controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</code></pre>
<p>å½“ç„¶ï¼Œé’ˆå¯¹æ—§ç‰ˆæœ¬çš„æµè§ˆå™¨å¯ä»¥å°è¯•æ·»åŠ  Polyfill ä»¥æ”¯æŒ AbortControllerã€‚</p>
<h3 id="23-react-hooks-ä¸­çš„å¼‚æ­¥ä»»åŠ¡">2.3 React hooks ä¸­çš„å¼‚æ­¥ä»»åŠ¡</h3>
<p>åœ¨ React ä¸­ï¼Œå¦‚æœ Effect åœ¨å†æ¬¡è§¦å‘ä¹‹å‰æ²¡æœ‰å®Œæˆï¼Œå¼€å‘è€…ä¸€èˆ¬ä¸å®¹æ˜“å‘ç°ï¼Œæ­¤æ—¶ Effect ä¼šå¹¶è¡Œè¿è¡Œã€‚</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FooComponent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>something<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> j <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url <span class="token operator">+</span> something<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// do something with J</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>something<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</code></pre>
<p>æ­¤æ—¶ï¼Œå¼€å‘è€…å¯ä»¥åšçš„æ˜¯åˆ›å»ºä¸€ä¸ª AbortControllerï¼Œæ¯å½“ä¸‹ä¸€ä¸ª useEffect è°ƒç”¨è¿è¡Œæ—¶å°±ä¸­æ­¢ä¸Šä¸€ä¸ªè¯·æ±‚ï¼š</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">FooComponent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>something<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>signal<span class="token punctuation">}</span> <span class="token operator">=</span> controller<span class="token punctuation">;</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// çœŸæ­£æ‰§è¡Œçš„é€»è¾‘</span>
      <span class="token keyword">const</span> j <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url <span class="token operator">+</span> something<span class="token punctuation">,</span> <span class="token punctuation">{</span> signal<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è¿™é‡Œå¤„ç†è¿”å›å€¼</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>something<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token operator">></span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
</code></pre>
<h3 id="24-react-hooks-ä¸­çš„å¼‚æ­¥ä»»åŠ¡">2.4 React hooks ä¸­çš„å¼‚æ­¥ä»»åŠ¡</h3>
<p>Node.js é‡Œæ–°ç‰ˆçš„ setTimeout å¯ä»¥ç”¨ AbortController å–æ¶ˆï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">setTimeout</span><span class="token operator">:</span> setTimeoutPromise <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:timers/promises"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> signal <span class="token operator">=</span> ac<span class="token punctuation">.</span>signal<span class="token punctuation">;</span>
<span class="token comment">// ğŸ“¢ è¿™é‡Œä¼ å…¥äº† AbortSignal</span>
<span class="token function">setTimeoutPromise</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"foobar"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> signal <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"AbortError"</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The timeout was aborted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ac<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</code></pre>
<p>ä¸è¿‡è¿™ä¸ª Promise ç‰ˆçš„ setTimeout å¹¶ä¸ä¼ å…¥å›è°ƒï¼Œå›è°ƒéœ€è¦åœ¨ .then() é‡Œæˆ–è€… await åé¢è‡ªå·±è°ƒç”¨ã€‚</p>
<p>ä½†æ˜¯ï¼Œæµè§ˆå™¨çš„ setTimeout ç›®å‰å¹¶ä¸æ”¯æŒ AbortControllerï¼Œå¯èƒ½æ˜¯åŸå› æ˜¯å…¶å·²ç»è®¾è®¡äº†æ›´å…ˆè¿›çš„ <code>scheduler.postTask() API</code>ï¼Œè¯¥æ–¹æ³•ç”¨äºæ ¹æ®ä¼˜å…ˆçº§æ·»åŠ è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå› æ­¤ setTimeout æ²¡ç†ç”±å¢å¼ºäº†ã€‚</p>
<pre><code class="language-js"><pre data-language="js"><code class="language-js"><span class="token comment">// Declare a TaskController with default priority</span>
<span class="token keyword">const</span> abortTaskController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Post task passing the controller's signal</span>
scheduler
  <span class="token punctuation">.</span><span class="token function">postTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Task executing"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">signal</span><span class="token operator">:</span> abortTaskController<span class="token punctuation">.</span>signal<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">taskResult</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>taskResult<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//This won't run!</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error:"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Log the error</span>
<span class="token comment">// Abort the task</span>
abortTaskController<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</code></pre>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ <code>TaskController</code> æ˜¯ AbortController çš„å­çº§ï¼Œé™¤äº†å¯ä»¥è°ƒç”¨ abort() å–æ¶ˆ taskï¼Œè¿˜å¯ä»¥é€šè¿‡ <code>setPriority()</code> æ–¹æ³•ä¸­é€”ä¿®æ”¹ task çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœä¸éœ€è¦æ§åˆ¶ä¼˜å…ˆçº§ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ AbortControllerã€‚</p>

            </div>
        </div>
        
        <div class="return-link">
            <a href="/">&larr; è¿”å›å¡ç‰‡åˆ—è¡¨</a>
        </div>
    </div>

    <!-- ç®€åŒ–åçš„æ¨¡æ€æ¡†ç»“æ„ -->
    <div class="modal-overlay" id="modalOverlay">
        <button class="modal-close" id="modalClose">&times;</button>
        <div id="modalContent">
            <!-- æ¨¡æ€æ¡†å†…å®¹å°†åœ¨è¿™é‡ŒåŠ è½½ -->
        </div>
    </div>
    
    <script src="/js/main.js"></script>
    <script src="/js/ink-effects.js"></script>
    <!-- Prism.js JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <!-- æ·»åŠ é¢å¤–çš„è¯­è¨€æ”¯æŒ -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
    <!-- é‡æ–°åˆå§‹åŒ–Prism.js -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ‰‹åŠ¨è§¦å‘Prismé«˜äº®ï¼Œç¡®ä¿åŠ¨æ€åŠ è½½çš„å†…å®¹ä¹Ÿèƒ½é«˜äº®
            Prism.highlightAll();
        });
    </script>
</body>
</html>